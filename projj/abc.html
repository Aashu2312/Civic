<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üåç Smart Dashboard</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Search Plugin -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.css"
    />
    <script src="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.js"></script>
    <!-- Leaflet MarkerCluster Plugin -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        display: flex;
        font-family: Arial, sans-serif;
        background-color: #ffffff;
        color: #333333;
      }
      .sidebar {
        width: 300px;
        height: 100vh;
        background-color: #f5f5f5;
        padding: 20px;
        border-right: 2px solid #cccccc;
        overflow-y: auto;
      }
      .sidebar h2 {
        text-align: center;
        margin-bottom: 15px;
        color: #00aaff;
      }
      .stats {
        background-color: #ffffff;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .stats p {
        margin: 5px 0;
      }
      .stats input {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #cccccc;
        border-radius: 5px;
        background-color: #f9f9f9;
        color: #333333;
      }
      .map-container {
        flex: 1;
        height: 100vh;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      .footer {
        text-align: center;
        margin-top: 15px;
        color: #666666;
        font-size: 12px;
      }
      #locationChart {
        width: 100% !important;
        height: 220px !important;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h2>üìä Live Dashboard</h2>
      <div class="stats">
        <h3>Real-time Stats</h3>
        <p>üü¢ Active Locations: <b id="locationCount">0</b></p>
        <p>üìç Last Update: <b id="lastUpdate">Loading...</b></p>
      </div>
      <div class="stats">
        <h3>Problem Areas</h3>
        <input type="text" id="cityFilter" placeholder="Filter by name..." />
        <ul id="topCities">
          <li>Loading...</li>
        </ul>
      </div>
      <div class="stats">
        <h3>Location Distribution</h3>
        <canvas id="locationChart"></canvas>
      </div>
      <div class="footer">Designed with ‚ù§ using Leaflet.js</div>
    </div>
    <div class="map-container">
      <div id="map"></div>
    </div>

    <script>
      // Initialize map
      const map = L.map("map").setView([23.349527, 85.329445], 14);

      // Light tiles
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
        maxZoom: 20,
      }).addTo(map);

      // Satellite layer (optional toggle)
      const satellite = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        { maxZoom: 19, attribution: "Tiles ¬© Esri" }
      );

      // Custom marker icon
      const customIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
        iconSize: [35, 35],
        iconAnchor: [17, 35],
        popupAnchor: [0, -35],
      });

      // Marker cluster group
      const markers = L.markerClusterGroup();

      // Initial locations
      let locations = [
        {
          name: "Pothole",
          lat: 23.37005,
          lng: 85.3251,
          info: "Large pothole near Kanke Road, causing delays.",
        },
        {
          name: "Garbage Overflow",
          lat: 23.39695,
          lng: 85.33325,
          info: "Overflowing garbage bin at Lalpur Chowk.",
        },
        {
          name: "Streetlight Issue",
          lat: 23.34485,
          lng: 85.31735,
          info: "Non-functional streetlight at GEL Church Complex.",
        },
        {
          name: "Pothole",
          lat: 23.355,
          lng: 85.327,
          info: "Another pothole near Ranchi Railway Station.",
        },
      ];

      // Update dashboard
      function updateDashboard(data) {
        markers.clearLayers();

        data.forEach((loc) => {
          const marker = L.marker([loc.lat, loc.lng], { icon: customIcon });
          bindPopup(
            `<b>${loc.name}</b><br>${loc.info}<br><small>${loc.lat.toFixed(
              5
            )}, ${loc.lng.toFixed(5)}</small>`
          );
          markers.addLayer(marker);
        });
        map.addLayer(markers);

        // Update stats
        document.getElementById("locationCount").innerText = data.length;
        document.getElementById("lastUpdate").innerText =
          new Date().toLocaleTimeString();

        // Top cities list
        const topCitiesList = document.getElementById("topCities");
        topCitiesList.innerHTML = "";
        data.slice(0, 5).forEach((loc) => {
          const li = document.createElement("li");
          li.textContent = loc.name;
          topCitiesList.appendChild(li);
        });

        // ‚úÖ Update chart counts
        const counts = {};
        data.forEach((loc) => {
          counts[loc.name] = (counts[loc.name] || 0) + 1;
        });

        const chartData = {
          labels: Object.keys(counts),
          datasets: [
            {
              label: "Reported Issues",
              data: Object.values(counts),
              backgroundColor: [
                "rgba(255, 99, 132, 0.6)",
                "rgba(54, 162, 235, 0.6)",
                "rgba(255, 206, 86, 0.6)",
                "rgba(75, 192, 192, 0.6)",
                "rgba(153, 102, 255, 0.6)",
              ],
              borderColor: "#333",
              borderWidth: 1,
            },
          ],
        };

        if (window.locationChart) window.locationChart.destroy();
        const ctx = document.getElementById("locationChart").getContext("2d");
        window.locationChart = new Chart(ctx, {
          type: "bar",
          data: chartData,
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } },
          },
        });

        // Fit map
        if (data.length > 0) {
          const bounds = L.latLngBounds(data.map((loc) => [loc.lat, loc.lng]));
          map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
        }
      }

      // Fake live data fetch
      async function fetchLiveData() {
        const newLocations = [
          {
            name: "Broken Pipe",
            lat: 23.35,
            lng: 85.32,
            info: "Water pipe burst near Doranda.",
          },
          {
            name: "Traffic Jam",
            lat: 23.36,
            lng: 85.33,
            info: "Heavy congestion at Harmu Chowk.",
          },
          {
            name: "Pothole",
            lat: 23.365,
            lng: 85.335,
            info: "Pothole near Morabadi Ground.",
          },
        ];

        locations = [...locations, ...newLocations];
        locations = locations.filter(
          (loc, i, self) =>
            i === self.findIndex((l) => l.lat === loc.lat && l.lng === loc.lng)
        );
        updateDashboard(locations);
      }

      // Filter by name
      document
        .getElementById("cityFilter")
        .addEventListener("input", function (e) {
          const searchTerm = e.target.value.toLowerCase();
          const filtered = locations.filter((loc) =>
            loc.name.toLowerCase().includes(searchTerm)
          );
          updateDashboard(filtered);
        });

      // Add search control
      L.Control.geocoder().addTo(map);

      // Initial load
      fetchLiveData();
      setInterval(fetchLiveData, 30000);
    </script>
  </body>
</html>
